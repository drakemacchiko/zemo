// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  phoneNumber  String?
  phoneVerified Boolean @default(false)
  otpCode      String?
  otpExpiry    DateTime?
  emailVerified Boolean @default(false)
  refreshToken String?
  
  // Phase 10: Admin & Role Management
  role         UserRole @default(USER)
  permissions  String?  // JSON string of permissions array
  mfaEnabled   Boolean  @default(false)
  mfaSecret    String?  // TOTP secret for MFA
  mfaBackupCodes String? // JSON string of backup codes
  lastLoginAt  DateTime?
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  profile      UserProfile?
  drivingLicense DrivingLicense?
  vehicles     Vehicle[]  // User can own multiple vehicles
  bookings     Booking[]  // User can have multiple bookings
  payments     Payment[]
  paymentMethods PaymentMethod[]
  insurancePolicies InsurancePolicy[] // User can have multiple insurance policies
  claims       Claim[]     // User can file multiple claims
  
  // Phase 9: Messaging & Support Relations
  hostConversations     Conversation[] @relation("HostConversations")
  renterConversations   Conversation[] @relation("RenterConversations")
  sentMessages         Message[]
  notifications        Notification[]
  notificationPreference NotificationPreference?
  supportTickets       SupportTicket[]
  ticketMessages       TicketMessage[]
  ticketAttachments    TicketAttachment[]

  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  dateOfBirth DateTime?
  address     String?
  city        String?
  country     String   @default("Zambia")
  profilePictureUrl String?
  kycStatus   KycStatus @default(PENDING)
  kycDocuments Json?  // Store document URLs and metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model DrivingLicense {
  id              String   @id @default(cuid())
  userId          String   @unique
  licenseNumber   String   @unique
  issueDate       DateTime
  expiryDate      DateTime
  issuingCountry  String   @default("Zambia")
  licenseClass    String   // e.g., "B", "C", "D"
  documentUrl     String?  // URL to uploaded license document
  verificationStatus VerificationStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("driving_licenses")
}

enum KycStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum UserRole {
  USER
  HOST
  ADMIN
  SUPER_ADMIN
}

model Vehicle {
  id              String   @id @default(cuid())
  hostId          String
  
  // Vehicle identification
  plateNumber     String   @unique
  engineNumber    String?
  chassisNumber   String?
  
  // Vehicle details
  make            String
  model           String
  year            Int
  color           String
  vehicleType     VehicleType
  transmission    Transmission
  fuelType        FuelType
  seatingCapacity Int
  
  // Pricing
  dailyRate       Float
  weeklyRate      Float?
  monthlyRate     Float?
  securityDeposit Float
  
  // Operational data
  currentMileage  Int
  fuelTankCapacity Float?
  locationLatitude  Float
  locationLongitude Float
  locationAddress   String
  
  // Status
  availabilityStatus AvailabilityStatus @default(AVAILABLE)
  verificationStatus VerificationStatus @default(PENDING)
  isActive        Boolean  @default(true)
  
  // Features and amenities
  features        Json?    // Store array of features as JSON
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  host            User     @relation(fields: [hostId], references: [id], onDelete: Cascade)
  documents       VehicleDocument[]
  photos          VehiclePhoto[]
  bookings        Booking[]
  inspections     VehicleInspection[]
  
  // Phase 9: Messaging & Support Relations
  conversations   Conversation[]
  notifications   Notification[]
  supportTickets  SupportTicket[]

  @@map("vehicles")
  @@index([hostId])
  @@index([availabilityStatus, isActive])
  @@index([locationLatitude, locationLongitude])
  @@index([vehicleType, availabilityStatus, isActive])
  @@index([make, model])
  @@index([dailyRate])
  @@index([seatingCapacity])
  @@index([year, make])
  @@index([verificationStatus, availabilityStatus])
  @@index([createdAt])
}

model VehicleDocument {
  id              String   @id @default(cuid())
  vehicleId       String
  documentType    DocumentType
  documentNumber  String?
  issueDate       DateTime?
  expiryDate      DateTime?
  documentUrl     String
  verificationStatus VerificationStatus @default(PENDING)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_documents")
  @@index([vehicleId])
}

// Signatures for vehicle documents (in-app signing or external provider)
model VehicleDocumentSignature {
  id                 String   @id @default(cuid())
  vehicleDocumentId  String
  signerId           String
  signerRole         UserRole
  signatureType      SignatureType
  externalProvider   String?   // e.g., DOCUSIGN
  externalId         String?   // provider signature id
  ipAddress          String?
  userAgent          String?
  auditData          Json?     // any additional audit info (coordinates, drawn path, etc.)
  signedAt           DateTime  @default(now())

  vehicleDocument    VehicleDocument @relation(fields: [vehicleDocumentId], references: [id], onDelete: Cascade)
  signer             User            @relation(fields: [signerId], references: [id])

  @@map("vehicle_document_signatures")
  @@index([vehicleDocumentId])
  @@index([signerId])
}

enum SignatureType {
  DRAW
  UPLOAD
  EXTERNAL
}

model VehiclePhoto {
  id              String   @id @default(cuid())
  vehicleId       String
  photoUrl        String
  photoType       PhotoType
  isPrimary       Boolean  @default(false)
  uploadDate      DateTime @default(now())

  // Relations
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_photos")
  @@index([vehicleId])
}

model Booking {
  id              String   @id @default(cuid())
  userId          String   // Renter
  vehicleId       String
  hostId          String   // Vehicle owner (for quick queries)
  
  // Booking period
  startDate       DateTime
  endDate         DateTime
  
  // Pricing details
  dailyRate       Float    // Rate at time of booking
  totalDays       Int
  subtotal        Float    // dailyRate * totalDays
  serviceFee      Float    @default(0)
  taxAmount       Float    @default(0)
  totalAmount     Float    // subtotal + serviceFee + taxAmount
  securityDeposit Float
  
  // Booking status and lifecycle
  status          BookingStatus @default(PENDING)
  confirmationNumber String @unique
  
  // Contact and pickup details
  pickupLocation  String?
  dropoffLocation String?
  specialRequests String?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  completedAt     DateTime?

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  payments        Payment[]
  insurancePolicy InsurancePolicy? // Booking can have one insurance policy
  claims          Claim[]  // Booking can have multiple claims
  inspections     VehicleInspection[]
  depositAdjustments DepositAdjustment[]
  
  // Phase 9: Messaging & Support Relations
  conversations   Conversation[]
  notifications   Notification[]
  supportTickets  SupportTicket[]

  @@map("bookings")
  @@index([userId])
  @@index([vehicleId])
  @@index([hostId])
  @@index([status])
  @@index([startDate, endDate])
  @@unique([vehicleId, startDate, endDate], name: "no_overlap_booking")
}

model Payment {
  id              String   @id @default(cuid())
  bookingId       String
  userId          String
  
  // Payment details
  amount          Float
  currency        String   @default("ZMW") // Zambian Kwacha
  paymentType     PaymentType
  provider        PaymentProvider
  
  // Payment flow
  status          PaymentStatus @default(PENDING)
  intent          PaymentIntent @default(PAYMENT) // PAYMENT, HOLD, REFUND
  
  // External provider references
  providerTransactionId String?
  providerReference     String?
  
  // Payment metadata
  paymentMethodId       String?
  failureReason         String?
  processedAt           DateTime?
  
  // Audit trail
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  transactions    Transaction[]

  @@map("payments")
  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([provider])
  @@index([providerTransactionId])
}

model PaymentMethod {
  id              String   @id @default(cuid())
  userId          String
  
  // Payment method details
  type            PaymentMethodType
  provider        PaymentProvider
  
  // Tokenized details (no raw card data)
  token           String   // Provider token reference
  last4           String?  // Last 4 digits for display
  brand           String?  // Card brand or mobile network
  expiryMonth     Int?     // For cards only
  expiryYear      Int?     // For cards only
  
  // Mobile money details
  phoneNumber     String?  // For mobile money
  accountName     String?  // Display name
  
  // Status
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments        Payment[]

  @@map("payment_methods")
  @@index([userId])
  @@index([type])
  @@index([provider])
}

model Transaction {
  id              String   @id @default(cuid())
  paymentId       String
  
  // Transaction details
  amount          Float
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  
  // External references
  providerTransactionId String?
  providerReference     String?
  
  // Reconciliation
  reconciledAt    DateTime?
  notes           String?
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  payment         Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("transactions")
  @@index([paymentId])
  @@index([type])
  @@index([status])
  @@index([providerTransactionId])
}

enum VehicleType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP
  VAN
  COUPE
  CONVERTIBLE
  WAGON
}

enum Transmission {
  MANUAL
  AUTOMATIC
}

enum FuelType {
  PETROL
  DIESEL
  HYBRID
  ELECTRIC
}

enum AvailabilityStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  UNAVAILABLE
}

enum DocumentType {
  LOGBOOK
  INSURANCE
  ROAD_TAX
  INSPECTION
}

enum PhotoType {
  EXTERIOR_FRONT
  EXTERIOR_REAR
  EXTERIOR_LEFT
  EXTERIOR_RIGHT
  INTERIOR_FRONT
  INTERIOR_REAR
  DASHBOARD
  ENGINE
  OTHER
}

enum BookingStatus {
  PENDING      // Awaiting host confirmation
  CONFIRMED    // Host approved booking
  ACTIVE       // Booking is currently active (vehicle picked up)
  COMPLETED    // Booking finished successfully
  CANCELLED    // Cancelled by user or host
  REJECTED     // Host rejected the booking
  NO_SHOW      // User didn't show up
}

enum PaymentType {
  BOOKING_PAYMENT    // Main rental payment
  SECURITY_DEPOSIT   // Security deposit hold
  REFUND            // Refund payment
  PARTIAL_REFUND    // Partial refund
  DAMAGE_CHARGE     // Additional damage charges
}

enum PaymentProvider {
  AIRTEL_MONEY
  MTN_MOMO
  ZAMTEL_KWACHA
  STRIPE
  DPO
}

enum PaymentStatus {
  PENDING       // Payment initiated
  PROCESSING    // Payment being processed
  COMPLETED     // Payment successful
  FAILED        // Payment failed
  CANCELLED     // Payment cancelled
  REFUNDED      // Payment refunded
  HELD          // Payment on hold (for deposits)
  RELEASED      // Hold released
}

enum PaymentIntent {
  PAYMENT       // Regular payment
  HOLD          // Hold funds (security deposit)
  REFUND        // Refund transaction
}

enum PaymentMethodType {
  MOBILE_MONEY
  CREDIT_CARD
  DEBIT_CARD
}

enum TransactionType {
  CHARGE        // Charge transaction
  HOLD          // Hold funds
  CAPTURE       // Capture held funds
  REFUND        // Refund transaction
  RELEASE       // Release held funds
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// Insurance Models
model Insurance {
  id               String   @id @default(cuid())
  
  // Insurance product details
  name             String   // e.g., "Basic Coverage", "Comprehensive"
  description      String
  coverageType     CoverageType
  
  // Coverage limits and details
  maxCoverageAmount Float   // Maximum coverage amount
  deductibleAmount Float    // Amount user pays before insurance kicks in
  
  // Coverage features
  accidentCoverage      Boolean @default(true)
  theftCoverage         Boolean @default(false)
  vandalismCoverage     Boolean @default(false)
  naturalDisasterCoverage Boolean @default(false)
  thirdPartyCoverage    Boolean @default(true)
  
  // Pricing
  dailyRate        Float   // Daily insurance premium
  weeklyRate       Float?  // Weekly rate (if different)
  monthlyRate      Float?  // Monthly rate (if different)
  
  // Status
  isActive         Boolean @default(true)
  
  // Provider details
  insuranceProvider String @default("ZEMO_PARTNER")
  policyTermsUrl   String?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  policies         InsurancePolicy[]

  @@map("insurance_products")
}

model InsurancePolicy {
  id               String   @id @default(cuid())
  bookingId        String   @unique // One policy per booking
  userId           String   // Policy holder
  insuranceId      String   // Insurance product
  
  // Policy details
  policyNumber     String   @unique
  coverageAmount   Float    // Actual coverage amount for this policy
  premiumAmount    Float    // Total premium paid
  deductibleAmount Float    // Deductible for this policy
  
  // Policy period (matches booking period)
  startDate        DateTime
  endDate          DateTime
  
  // Policy status
  status           PolicyStatus @default(PENDING)
  
  // External provider references
  providerPolicyId String?  // External insurer policy ID
  providerReference String? // External reference
  
  // Policy documents
  policyDocumentUrl String? // URL to policy document
  
  // Claims relationship
  activatedAt      DateTime?
  cancelledAt      DateTime?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  insurance        Insurance @relation(fields: [insuranceId], references: [id])
  claims           Claim[]

  @@map("insurance_policies")
  @@index([userId])
  @@index([status])
  @@index([policyNumber])
}

model Claim {
  id               String   @id @default(cuid())
  policyId         String   // Associated insurance policy
  bookingId        String   // Associated booking
  userId           String   // Claimant (usually the renter)
  
  // Claim details
  claimNumber      String   @unique
  incidentDate     DateTime
  incidentLocation String
  incidentDescription String
  
  // Claim type and damage assessment
  claimType        ClaimType
  estimatedDamageAmount Float?
  actualDamageAmount    Float?
  
  // Claim status and workflow
  status           ClaimStatus @default(SUBMITTED)
  priority         ClaimPriority @default(NORMAL)
  
  // External references
  policeReportNumber String?
  insurerClaimId     String? // External insurer claim ID
  
  // Review and processing
  reviewedBy       String?  // Admin user ID who reviewed
  reviewedAt       DateTime?
  reviewNotes      String?
  
  // Settlement
  settlementAmount Float?
  settlementDate   DateTime?
  settlementNotes  String?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  policy           InsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents        ClaimDocument[]

  @@map("claims")
  @@index([userId])
  @@index([policyId])
  @@index([bookingId])
  @@index([status])
  @@index([claimNumber])
}

model ClaimDocument {
  id               String   @id @default(cuid())
  claimId          String   // Associated claim
  
  // Document details
  documentType     ClaimDocumentType
  fileName         String
  originalFileName String
  fileSize         Int
  mimeType         String
  documentUrl      String   // URL to stored document
  
  // Document metadata
  uploadedBy       String   // User ID who uploaded
  description      String?
  
  // Verification
  isVerified       Boolean  @default(false)
  verifiedBy       String?  // Admin user ID who verified
  verifiedAt       DateTime?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  claim            Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@map("claim_documents")
  @@index([claimId])
  @@index([documentType])
}

// Insurance and Claims Enums
enum CoverageType {
  BASIC           // Basic third-party coverage
  COMPREHENSIVE   // Full coverage including theft, vandalism
  PREMIUM         // Premium coverage with additional benefits
}

enum PolicyStatus {
  PENDING         // Policy created but not activated
  ACTIVE          // Policy is active and covers the period
  EXPIRED         // Policy period has ended
  CANCELLED       // Policy was cancelled
  SUSPENDED       // Policy temporarily suspended
}

enum ClaimType {
  ACCIDENT        // Traffic accident
  THEFT           // Vehicle theft
  VANDALISM       // Vandalism damage
  NATURAL_DISASTER // Weather/natural disaster damage
  MECHANICAL      // Mechanical breakdown (if covered)
  THIRD_PARTY     // Third-party liability claim
}

enum ClaimStatus {
  SUBMITTED       // Claim submitted by user
  UNDER_REVIEW    // Claim being reviewed by admin
  INVESTIGATING   // Claim under investigation
  APPROVED        // Claim approved for settlement
  REJECTED        // Claim rejected
  SETTLED         // Claim settled and paid
  CLOSED          // Claim closed (no further action)
}

enum ClaimPriority {
  LOW             // Minor damage, no urgency
  NORMAL          // Standard priority
  HIGH            // Significant damage or urgent
  URGENT          // Emergency or major incident
}

enum ClaimDocumentType {
  PHOTOS          // Photos of damage/incident
  POLICE_REPORT   // Official police report
  MEDICAL_REPORT  // Medical reports (if applicable)
  REPAIR_INVOICE  // Repair shop invoices
  RECEIPT         // Payment receipts
  WITNESS_STATEMENT // Witness statements
  OTHER           // Other supporting documents
}

// Phase 7: Vehicle Handover & Return Models
model VehicleInspection {
  id               String   @id @default(cuid())
  bookingId        String
  vehicleId        String
  inspectorId      String   // User performing inspection (renter or host)
  
  // Inspection type and timing
  inspectionType   InspectionType
  inspectionDate   DateTime @default(now())
  
  // Vehicle condition at inspection
  mileage          Int
  fuelLevel        Float    // Percentage (0-100)
  
  // Damage assessment
  overallCondition VehicleCondition
  damageScore      Float    @default(0) // 0-100, higher = more damage
  estimatedRepairCost Float @default(0)
  
  // Inspection notes
  notes            String?
  concerns         String?  // Specific concerns or issues noted
  
  // GPS location of inspection
  locationLatitude  Float?
  locationLongitude Float?
  locationAddress   String?
  
  // Inspection status
  status           InspectionStatus @default(PENDING)
  acknowledgedBy   String?  // Other party (host/renter) acknowledgment
  acknowledgedAt   DateTime?
  disputeRaised    Boolean  @default(false)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vehicle          Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  photos           InspectionPhoto[]
  damageItems      DamageItem[]

  @@map("vehicle_inspections")
  @@index([bookingId])
  @@index([vehicleId])
  @@index([inspectionType])
  @@index([status])
}

model InspectionPhoto {
  id               String   @id @default(cuid())
  inspectionId     String
  
  // Photo details
  photoUrl         String
  photoType        InspectionPhotoType
  viewAngle        String?  // e.g., "front-left", "dashboard", "odometer"
  
  // Photo metadata
  fileName         String
  fileSize         Int
  mimeType         String
  
  // Damage association
  isDamagePhoto    Boolean  @default(false)
  damageDescription String? // Description of damage shown in photo
  
  // GPS and timestamp
  latitude         Float?
  longitude        Float?
  takenAt          DateTime @default(now())
  
  // Metadata
  createdAt        DateTime @default(now())
  
  // Relations
  inspection       VehicleInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@map("inspection_photos")
  @@index([inspectionId])
  @@index([photoType])
}

model DamageItem {
  id               String   @id @default(cuid())
  inspectionId     String
  
  // Damage details
  damageType       DamageType
  severity         DamageSeverity
  location         String   // e.g., "front bumper", "rear door", "windshield"
  description      String
  
  // Damage assessment
  repairRequired   Boolean  @default(true)
  estimatedCost    Float    @default(0)
  actualCost       Float?   // Set after repair
  
  // Evidence
  photoUrls        Json?    // Array of photo URLs showing this damage
  
  // Processing
  isDisputed       Boolean  @default(false)
  resolvedBy       String?  // Admin who resolved dispute
  resolvedAt       DateTime?
  resolutionNotes  String?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  inspection       VehicleInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@map("damage_items")
  @@index([inspectionId])
  @@index([damageType])
  @@index([severity])
}

model DepositAdjustment {
  id               String   @id @default(cuid())
  bookingId        String
  pickupInspectionId String?
  returnInspectionId String?
  
  // Adjustment details
  originalDeposit  Float
  damageCharges    Float    @default(0)
  cleaningCharges  Float    @default(0)
  fuelCharges      Float    @default(0)
  otherCharges     Float    @default(0)
  adjustmentAmount Float    // Total adjustment (positive = charge, negative = refund)
  finalDepositReturn Float  // Amount to return to renter
  
  // Processing
  status           DepositStatus @default(PENDING)
  processedBy      String?  // Admin who processed
  processedAt      DateTime?
  
  // Justification
  justification    String?  // Explanation for charges
  evidenceUrls     Json?    // Supporting evidence URLs
  
  // Dispute handling
  isDisputed       Boolean  @default(false)
  disputeReason    String?
  disputeResolvedBy String?
  disputeResolvedAt DateTime?
  
  // Payment processing
  paymentId        String?  // Associated payment for additional charges
  refundId         String?  // Associated refund payment
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("deposit_adjustments")
  @@index([bookingId])
  @@index([status])
}

// Phase 7 Enums
enum InspectionType {
  PICKUP          // Pre-rental inspection
  RETURN          // Post-rental inspection
  INTERMEDIATE    // Mid-rental check (for long rentals)
  DAMAGE_ASSESSMENT // Special damage inspection
}

enum VehicleCondition {
  EXCELLENT       // No visible damage
  GOOD            // Minor cosmetic issues
  FAIR            // Some wear and tear
  POOR            // Significant damage/issues
  DAMAGED         // Major damage requiring repair
}

enum InspectionStatus {
  PENDING         // Inspection created but not completed
  COMPLETED       // Inspection finished by inspector
  ACKNOWLEDGED    // Other party has acknowledged inspection
  DISPUTED        // Dispute raised about inspection
  RESOLVED        // Dispute resolved
}

enum InspectionPhotoType {
  EXTERIOR_OVERVIEW // Full vehicle exterior
  INTERIOR_OVERVIEW // Interior overview
  DASHBOARD        // Dashboard/odometer reading
  DAMAGE_CLOSEUP   // Close-up of specific damage
  FUEL_GAUGE       // Fuel level indicator
  MILEAGE          // Odometer reading
  TIRE_CONDITION   // Tire condition
  SCRATCH_DENT     // Scratches or dents
  OTHER            // Other inspection photos
}

enum DamageType {
  SCRATCH          // Surface scratches
  DENT             // Body dents
  CRACK            // Cracks (windshield, etc.)
  BROKEN_PART      // Broken components
  MISSING_PART     // Missing parts/accessories
  INTERIOR_DAMAGE  // Interior damage
  MECHANICAL_ISSUE // Mechanical problems
  ELECTRICAL_ISSUE // Electrical problems
  TIRE_DAMAGE      // Tire damage
  FLUID_LEAK       // Fluid leaks
  OTHER            // Other damage types
}

enum DamageSeverity {
  MINOR            // Cosmetic, no functional impact
  MODERATE         // Some functional impact, repairable
  MAJOR            // Significant damage, costly repair
  SEVERE           // Extensive damage, may be total loss
}

enum DepositStatus {
  PENDING          // Awaiting processing
  CALCULATED       // Adjustment calculated
  APPROVED         // Approved for processing
  PROCESSED        // Payment/refund processed
  DISPUTED         // Under dispute
  RESOLVED         // Dispute resolved
}

// Phase 9: Messaging, Notifications & Support Models
model Conversation {
  id               String   @id @default(cuid())
  
  // Participants
  hostId           String   // Vehicle host
  renterId         String   // Vehicle renter
  bookingId        String?  // Optional associated booking
  vehicleId        String?  // Optional associated vehicle
  
  // Conversation metadata
  title            String?  // Optional conversation title
  lastMessageAt    DateTime?
  isArchived       Boolean  @default(false)
  
  // Privacy settings
  hostDeleted      Boolean  @default(false)
  renterDeleted    Boolean  @default(false)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  host             User     @relation("HostConversations", fields: [hostId], references: [id])
  renter           User     @relation("RenterConversations", fields: [renterId], references: [id])
  booking          Booking? @relation(fields: [bookingId], references: [id])
  vehicle          Vehicle? @relation(fields: [vehicleId], references: [id])
  messages         Message[]

  @@map("conversations")
  @@index([hostId])
  @@index([renterId])
  @@index([bookingId])
  @@index([vehicleId])
  @@index([lastMessageAt])
  @@unique([hostId, renterId, bookingId]) // Prevent duplicate conversations
}

model Message {
  id               String   @id @default(cuid())
  conversationId   String
  senderId         String
  
  // Message content
  content          String
  messageType      MessageType @default(TEXT)
  
  // Message metadata
  isRead           Boolean  @default(false)
  readAt           DateTime?
  isEdited         Boolean  @default(false)
  editedAt         DateTime?
  
  // Content moderation
  isDeleted        Boolean  @default(false)
  deletedAt        DateTime?
  deletedBy        String?
  
  // Attachments
  attachmentUrl    String?  // Optional file attachment
  attachmentType   AttachmentType?
  attachmentSize   Int?     // File size in bytes
  
  // System messages
  systemMetadata   Json?    // For system messages (booking updates, etc.)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender           User     @relation(fields: [senderId], references: [id])

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isRead])
}

model Notification {
  id               String   @id @default(cuid())
  userId           String
  
  // Notification content
  type             NotificationType
  title            String
  message          String
  actionUrl        String?  // URL for notification action
  
  // Notification metadata
  isRead           Boolean  @default(false)
  readAt           DateTime?
  
  // Delivery channels
  deliveryChannels String   @default("IN_APP") // JSON string of channels
  emailSent        Boolean  @default(false)
  emailSentAt      DateTime?
  smsSent          Boolean  @default(false)
  smsSentAt        DateTime?
  pushSent         Boolean  @default(false)
  pushSentAt       DateTime?
  
  // Related entities
  bookingId        String?
  vehicleId        String?
  conversationId   String?
  ticketId         String?
  
  // Priority and scheduling
  priority         NotificationPriority @default(NORMAL)
  scheduledFor     DateTime? // For scheduled notifications
  expiresAt        DateTime? // Notification expiry
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking          Booking? @relation(fields: [bookingId], references: [id])
  vehicle          Vehicle? @relation(fields: [vehicleId], references: [id])

  @@map("notifications")
  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([priority])
  @@index([scheduledFor])
  @@index([createdAt])
}

model NotificationPreference {
  id               String   @id @default(cuid())
  userId           String   @unique
  
  // Channel preferences
  emailEnabled     Boolean  @default(true)
  smsEnabled       Boolean  @default(true)
  pushEnabled      Boolean  @default(true)
  
  // Notification type preferences
  bookingUpdates   Boolean  @default(true)
  paymentUpdates   Boolean  @default(true)
  messageAlerts    Boolean  @default(true)
  marketingEmails  Boolean  @default(false)
  systemAlerts     Boolean  @default(true)
  
  // Timing preferences
  quietHoursStart  Int?     // Hour (0-23) when quiet hours start
  quietHoursEnd    Int?     // Hour (0-23) when quiet hours end
  timezone         String   @default("Africa/Lusaka")
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model SupportTicket {
  id               String   @id @default(cuid())
  userId           String
  
  // Ticket identification
  ticketNumber     String   @unique
  
  // Ticket content
  subject          String
  description      String
  category         TicketCategory
  priority         TicketPriority @default(NORMAL)
  
  // Status and assignment
  status           TicketStatus @default(OPEN)
  assignedToId     String?  // Admin user assigned to ticket
  
  // Related entities
  bookingId        String?
  vehicleId        String?
  paymentId        String?
  
  // Resolution
  resolutionNotes  String?
  resolvedAt       DateTime?
  resolvedBy       String?  // Admin user who resolved
  
  // Customer satisfaction
  customerRating   Int?     // 1-5 rating
  customerFeedback String?
  
  // Internal notes
  internalNotes    String?
  tags             Json?    // Array of tags for categorization
  
  // Escalation
  escalatedAt      DateTime?
  escalatedBy      String?
  escalationReason String?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  user             User     @relation(fields: [userId], references: [id])
  booking          Booking? @relation(fields: [bookingId], references: [id])
  vehicle          Vehicle? @relation(fields: [vehicleId], references: [id])
  messages         TicketMessage[]
  attachments      TicketAttachment[]

  @@map("support_tickets")
  @@index([userId])
  @@index([ticketNumber])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdAt])
}

model TicketMessage {
  id               String   @id @default(cuid())
  ticketId         String
  senderId         String
  
  // Message content
  content          String
  isInternal       Boolean  @default(false) // Internal admin notes
  
  // Message metadata
  isEdited         Boolean  @default(false)
  editedAt         DateTime?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  ticket           SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender           User     @relation(fields: [senderId], references: [id])

  @@map("ticket_messages")
  @@index([ticketId])
  @@index([senderId])
  @@index([isInternal])
  @@index([createdAt])
}

model TicketAttachment {
  id               String   @id @default(cuid())
  ticketId         String
  uploadedBy       String
  
  // File details
  fileName         String
  originalFileName String
  fileSize         Int
  mimeType         String
  fileUrl          String
  
  // File metadata
  description      String?
  
  // Metadata
  createdAt        DateTime @default(now())
  
  // Relations
  ticket           SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploader         User     @relation(fields: [uploadedBy], references: [id])

  @@map("ticket_attachments")
  @@index([ticketId])
  @@index([uploadedBy])
}

// Phase 9 Enums
enum MessageType {
  TEXT             // Regular text message
  SYSTEM           // System-generated message
  BOOKING_UPDATE   // Booking status update
  PAYMENT_UPDATE   // Payment status update
  IMAGE            // Image attachment
  DOCUMENT         // Document attachment
}

enum AttachmentType {
  IMAGE            // Image file
  DOCUMENT         // PDF, DOC, etc.
  VIDEO            // Video file
  OTHER            // Other file types
}

enum NotificationType {
  BOOKING_CONFIRMED    // Booking confirmed by host
  BOOKING_CANCELLED    // Booking cancelled
  PAYMENT_SUCCESS      // Payment successful
  PAYMENT_FAILED       // Payment failed
  MESSAGE_RECEIVED     // New message received
  VEHICLE_APPROVED     // Vehicle listing approved
  DOCUMENT_REQUIRED    // Document upload required
  INSPECTION_DUE       // Vehicle inspection due
  SUPPORT_RESPONSE     // Support ticket response
  SYSTEM_ANNOUNCEMENT  // System-wide announcement
  MARKETING           // Marketing communication
}

enum NotificationChannel {
  IN_APP              // In-app notification
  EMAIL               // Email notification
  SMS                 // SMS notification
  PUSH                // Push notification
}

enum NotificationPriority {
  LOW                 // Low priority
  NORMAL              // Normal priority
  HIGH                // High priority
  URGENT              // Urgent priority
}

enum TicketCategory {
  BOOKING_ISSUE       // Booking-related issues
  PAYMENT_ISSUE       // Payment problems
  VEHICLE_ISSUE       // Vehicle-related problems
  TECHNICAL_SUPPORT   // Technical app issues
  ACCOUNT_ISSUE       // Account-related problems
  DAMAGE_DISPUTE      // Damage assessment disputes
  REFUND_REQUEST      // Refund requests
  FEATURE_REQUEST     // Feature requests
  COMPLAINT           // General complaints
  OTHER               // Other issues
}

enum TicketPriority {
  LOW                 // Low priority
  NORMAL              // Normal priority
  HIGH                // High priority
  URGENT              // Urgent priority
  CRITICAL            // Critical priority
}

enum TicketStatus {
  OPEN                // Ticket is open
  IN_PROGRESS         // Being worked on
  WAITING_CUSTOMER    // Waiting for customer response
  WAITING_INTERNAL    // Waiting for internal response
  RESOLVED            // Resolved
  CLOSED              // Closed
  ESCALATED           // Escalated to higher level
}